name: AVT DucTheng

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest # Windows 11
    timeout-minutes: 360 # T·ªëi ƒëa 6 ti·∫øng

    steps:
      # 1. K·∫øt n·ªëi v√†o m·∫°ng Tailscale
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest
          hostname: avt-duc-theng

      # 2. C·∫•u h√¨nh T√†i kho·∫£n v√† RDP (Fix Full)
      - name: Configure User and RDP (RDP Only)
        env:
          USER_PASSWORD: ${{ secrets.RDP_PASSWORD }} 
        run: |
          $ErrorActionPreference = "Stop"
          $NewUser = "DucThengGaming"
          $NewPass = $env:USER_PASSWORD
          $SecurePass = ConvertTo-SecureString $NewPass -AsPlainText -Force

          Write-Host "--- A. C·∫•u h√¨nh T√†i kho·∫£n ---"
          if (-not (Get-LocalUser -Name $NewUser -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $NewUser -Password $SecurePass -FullName "Gaming VPS User" -Description "Custom GitHub RDP User" -ErrorAction Stop
            Add-LocalGroupMember -Group "Administrators" -Member $NewUser -ErrorAction Stop
          } else {
            Set-LocalUser -Name $NewUser -Password $SecurePass -ErrorAction Stop
          }

          Write-Host "--- B. T·∫°o RDP Banner ---"
          $IntroTitle = "üíé VPS PREMIUM SI√äU X·ªäN: AVT DUC THENG! (RDP Only) üíé"
          $IntroText = "WELCOME, BOSS! Phi√™n b·∫£n RDP-Only ·ªïn ƒë·ªãnh. Gi·ªõi h·∫°n 6 ti·∫øng. Vui l√≤ng l∆∞u tr·ªØ d·ªØ li·ªáu an to√†n!"
          
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -name "legalnoticecaption" -Value $IntroTitle -ErrorAction Stop
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -name "legalnoticetext" -Value $IntroText -ErrorAction Stop
          
          Write-Host "--- C. K√≠ch ho·∫°t RDP ---"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0 -ErrorAction Stop
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction Stop
          
          Write-Host "C·∫•u h√¨nh RDP th√†nh c√¥ng."

      # 3. D·ªçn d·∫πp h·ªá th·ªëng Windows
      - name: System Optimization (Cleanup)
        run: |
          Write-Host "B·∫Øt ƒë·∫ßu d·ªçn d·∫πp file r√°c h·ªá th·ªëng..."
          Remove-Item -Path C:\Windows\Temp\* -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $env:TEMP\* -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "D·ªçn d·∫πp ho√†n t·∫•t!"

      # 4. Hi·ªÉn th·ªã th√¥ng b√°o h∆∞·ªõng d·∫´n
      - name: H∆∞·ªõng d·∫´n k·∫øt n·ªëi
        run: |
          Write-Host "==================================================="
          Write-Host "WINDOWS VPS ƒê√É S·∫¥N S√ÄNG! (FIX FULL - RDP ONLY)"
          Write-Host "Hostname: avt-duc-theng"
          Write-Host "User: DucThengGaming"
          Write-Host "Pass: (M·∫≠t kh·∫©u Secret)"
          Write-Host "==================================================="

      # 5. Treo m√°y (Keep Alive)
      - name: Keep Alive
        run: |
          Write-Host "ƒêang ch·∫°y... ƒê·ª´ng ƒë√≥ng tab n√†y."
          while ($true) {
            Start-Sleep -Seconds 60
          }
